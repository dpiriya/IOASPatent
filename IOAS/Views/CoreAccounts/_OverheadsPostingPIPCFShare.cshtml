
@model IOAS.Models.OverheadsPostingModel
@using (Html.BeginForm("_SavePIPCFShare", "CoreAccounts", FormMethod.Post, new { @class = "", role = "form", @id = "formOP", enctype = "multipart/form-data" }))
{
<div class="row mt30">
    <div id="ViewDetailsModal" class="modal fade modal-pr-vw" role="dialog">
        <div class="modal-dialog modal-md">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <div class="row hd-tt-bg">
                        <div class="col-md-12">
                            <h4><b>Overheads PI PCF Share</b></h4>
                        </div>
                    </div>
                </div>
                <div class="gray-bg br-rd">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="row m-b-sm">
                                <div class="col-md-6">
                                    <h3 class="mt-xs">Details</h3>
                                </div>
                                @*<div class="col-md-6 text-right">
                            <a href="javascript:void(0)" id="btnAddHonor" class="btn btn-primary btnAddHonor">Add New</a>
                        </div>*@
                            </div>
                            <div class="m-b-sm scrl-table scrl-table-po-bl">
                                <table class="table table-bordered" style="width: 780px;">
                                    <thead>
                                        <tr>
                                            <th colspan="10"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyOH">
                                        <tr>

                                            <td style="width: 200px;">PI Name</td>                                           
                                            <td style="width: 100px;">PCF Percent</td>
                                            <td style="width: 100px;">PCF Amount</td>
                                           
                                        </tr>
                                        @if (Model.PIShareDetails != null)
                                        {
                                            var count = 0;
                                            foreach (var item in Model.PIShareDetails)
                                            {
                                                var piid = "PIShareDetails[" + count + "].PIId";
                                                var projectid = "PIShareDetails[" + count + "].ProjectId";
                                                //var projecttype = "PIShareDetails[" + count + "].ProjectType";
                                                var piname = "PIShareDetails[" + count + "].NameofPI";
                                                var detailsid = "PIShareDetails[" + count + "].OverheadsPIShareDetailsId";
                                                var pcfpercent = "PIShareDetails[" + count + "].PCFPercent";
                                                var oldpcfpercent = "PIShareDetails[" + count + "].OldPCFPercent";
                                                var pcfamount = "PIShareDetails[" + count + "].PCFAmount";
                                                var totalrmfamt = "PIShareDetails[" + count + "].TotalPCFAmount";
                                                <tr id="trdetails" class="p-b-sm">
                                                    <td>
                                                        @Html.TextBox(@piname, item.NameofPI, new { @class = "form-control", @autocomplete = "off", @readonly = true })
                                                        @Html.ValidationMessage(@piname)
                                                        @Html.Hidden("PIShareDetails.Index", @count)
                                                        @Html.TextBox(@piid, item.PIId, new { @class = "form-control dis-none" }) 
                                                        @Html.TextBox(@projectid, item.ProjectId, new { @class = "form-control dis-none" })
                                                        @*@Html.TextBox(@projecttype, item.ProjectType, new { @class = "form-control dis-none" })*@
                                                        @Html.TextBox(@detailsid, item.OverheadsPIShareDetailsId, new { @class = "form-control dis-none" })    
                                                        @Html.TextBox(@totalrmfamt, item.TotalPCFAmount, new { @class = "form-control dis-none" })                                                   
                                                    </td>
                                                    <td>
                                                        @Html.TextBox(@pcfpercent, item.PCFPercent, new { @class = "form-control", @autocomplete = "off" })
                                                        @Html.TextBox(@oldpcfpercent, item.OldPCFPercent, new { @class = "form-control dis-none" })
                                                        @Html.ValidationMessage(@pcfpercent)
                                                    </td>
                                                    <td>
                                                        @Html.TextBox(@pcfamount, item.PCFAmount, new { @class = "form-control", @autocomplete = "off", @readonly = true })
                                                        @Html.ValidationMessage(@pcfamount)
                                                    </td>
              
                                                </tr>
                                                count++;
                                            }

                                        }

                                        else
                                        {
                                            <tr>
                                                <td>
                                                    @Html.TextBox("PIShareDetails[0].NameofPI", "", new { @class = "form-control", @id = "txtname", @autocomplete = "off" })
                                                    @Html.Hidden("PIShareDetails.Index", "0")
                                                    @Html.ValidationMessage("PIShareDetails[0].NameofPI")
                                                    @Html.TextBox("PIShareDetails[0].PIId", "", new { @class = "form-control dis-none" })
                                                    @Html.TextBox("PIShareDetails[0].ProjectId", "", new { @class = "form-control dis-none" })
                                                    @*@Html.TextBox("PIShareDetails[0].ProjectType", "", new { @class = "form-control dis-none" })*@
                                                    @Html.TextBox("PIShareDetails[0].OverheadsPIShareDetailsId", "", new { @class = "form-control dis-none" })
                                                    @Html.TextBox("PIShareDetails[0].TotalPCFAmount", "", new { @class = "form-control dis-none" })
                                                </td>
                                                <td>
                                                    @Html.TextBox("PIShareDetails[0].PCFPercent", "", new { @class = "form-control", @autocomplete = "off" })
                                                    @Html.TextBox("PIShareDetails[0].OldPCFPercent", "", new { @class = "form-control dis-none" })
                                                    @Html.ValidationMessage("PIShareDetails[0].PCFPercent")
                                                </td>
                                                <td>
                                                    @Html.TextBox("PIShareDetails[0].PCFAmount", "", new { @class = "form-control", @autocomplete = "off" })
                                                    @Html.ValidationMessage("PIShareDetails[0].PCFAmount")
                                                </td>
                                               
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <input type="submit" class="btn btn-primary pull-right" value="Update PCF Share" name="Button" id="btnSave" />
                </div>
            </div>

        </div>
    </div>
</div>
}
<script type="text/javascript">

    $(document).ready(function () {
        var errMsg = '@ViewBag.errMsg';
        if (errMsg) {
            $("#FailedAlert").html(errMsg);
            $('#Failed').modal('show');
        }
    });
    $(document).on('change', 'input[name$=".PCFPercent"]', function () {
        
        var totalPCFPercent = 0;
        $('#tbodyOH tr').each(function (idx, val) {
            var pcfpercent = parseFloat($(this).closest('tr').find('input[name$=".PCFPercent"]').val() || 0);
            totalPCFPercent += pcfpercent;
        });

        $('#tbodyOH tr').each(function (idx, val) {
            var pcfpercent = parseFloat($(this).closest('tr').find('input[name$=".PCFPercent"]').val() || 0);
            var totalPCFValue = parseFloat($(this).closest('tr').find('input[name$=".TotalPCFAmount"]').val() || 0);
            var PCFValue = (totalPCFValue * (pcfpercent / totalPCFPercent)).toFixed(0);
            $(this).closest('tr').find('input[name$=".PCFAmount"]').val(PCFValue);
        });

    });
    $('[id^="btnSave"]').on('click', function (e) {
        
        var isValid = $('#formOP').valid();
        if (!isValid)
            return false;
        var totalPCFPercent = 0;
        $('#tbodyOH tr').each(function (idx, val) {
            var pcfpercent = parseFloat($(this).closest('tr').find('input[name$=".PCFPercent"]').val() || 0);
            totalPCFPercent += pcfpercent;
        });
        if (totalPCFPercent != 100)
        {
            $("#FailedAlert").html('The total PCF Percent is not equal to 100 percent');
            $('#Failed').modal('show');
            return false;
        }
        else if(totalPCFPercent == 100) {
            isValid = true;
        }
        if (isValid)
        $('#formOP').submit();
        @*e.preventDefault();
        var modelData = '@Html.Raw(Json.Encode(Model))';
        var model = JSON.parse(modelData);
        var model = new FormData();
        model.append("selCommitmentType", CommitType);
        var ajaxOpts = {
            type: "POST",
            url: updatePIShare,
            data: $("form").serialize(),
            //data: { "ProjectType": Projecttype, "ProposalNumber": Proposalnumber, "FromSOdate": FromSODate, "ToSOdate": ToSODate, },
            contentType: false,//"application/x-www-form-urlencoded",
            dataType: "json",
            processData: false,
            success: function (result) {
                // dataProposal = result;
                var res = result
                if (res == 1)
                {
                    $('#ViewDetailsModal').hide();
                    $('body').removeClass('modal-open');
                    $(".modal-backdrop").remove();
                }

                //  $('.modal-backdrop').remove();
                //  EmptyCommitmentSrchList()



        //   $('#popupFilter').hide();
    },
        error: function (err) {

            console.log("error : " + err);
        }
    };*@

    });
</script>